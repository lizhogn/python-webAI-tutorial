# 3.3 çŠ¶æ€ç®¡ç†ï¼šä½¿ç”¨ Pinia é›†ä¸­ç®¡ç†æ•°æ®

## ğŸ“– æ¦‚è¿°

å½“æˆ‘ä»¬æ„å»ºå¤§å‹åº”ç”¨æ—¶ï¼Œå¤šä¸ªç»„ä»¶å¯èƒ½éœ€è¦è®¿é—®æˆ–ä¿®æ”¹åŒä¸€ä»½æ•°æ®ï¼ˆä¾‹å¦‚ï¼Œå½“å‰ç™»å½•çš„ç”¨æˆ·ä¿¡æ¯ï¼‰ã€‚å¦‚æœä»…ä»…ä¾èµ–çˆ¶å­ç»„ä»¶ä¹‹é—´çš„ Props å’Œ Eventsï¼Œä¼šå¯¼è‡´æ•°æ®æµæ··ä¹±ï¼Œéš¾ä»¥ç»´æŠ¤ï¼Œè¿™ç§æƒ…å†µè¢«ç§°ä¸º"**Prop é€çº§é€ä¼  (Prop Drilling)**"ã€‚

**çŠ¶æ€ç®¡ç†åº“**å°±æ˜¯ä¸ºäº†è§£å†³è¿™ä¸ªé—®é¢˜è€Œç”Ÿçš„ã€‚å®ƒæä¾›äº†ä¸€ä¸ªé›†ä¸­çš„"ä»“åº“ (Store)"ï¼Œä»»ä½•ç»„ä»¶éƒ½å¯ä»¥ç›´æ¥ä»ä¸­è¯»å–æˆ–ä¿®æ”¹æ•°æ®ï¼Œè€Œæ— éœ€å…³å¿ƒç»„ä»¶çš„å±‚çº§å…³ç³»ã€‚

åœ¨ Vue 3 ä¸­ï¼Œå®˜æ–¹æ¨èçš„çŠ¶æ€ç®¡ç†åº“æ˜¯ **Pinia** (å‘éŸ³ä¸º /piËnjÊŒ/ï¼Œç±»ä¼¼äº "peenya")ã€‚

## ğŸ ä¸ºä»€ä¹ˆé€‰æ‹© Piniaï¼Ÿ

Pinia æ˜¯ Vue çš„æ–°ä¸€ä»£å®˜æ–¹çŠ¶æ€ç®¡ç†åº“ï¼Œç›¸æ¯”äºå®ƒçš„å‰è¾ˆ Vuexï¼ŒPinia æä¾›äº†ï¼š
- **æ›´ç®€æ´çš„ API**: æ›´å°‘çš„æ ·æ¿ä»£ç ï¼Œä¸ç»„åˆå¼ API å®Œç¾å¥‘åˆã€‚
- **ç±»å‹å®‰å…¨**: å¯¹ TypeScript æœ‰ç€æ— ä¸ä¼¦æ¯”çš„æ”¯æŒï¼Œèƒ½æä¾›å®Œç¾çš„è‡ªåŠ¨è¡¥å…¨ã€‚
- **æ›´è½»é‡**: ä½“ç§¯æå°ï¼Œä»…æœ‰çº¦ 1KBã€‚
- **æ¨¡å—åŒ–è®¾è®¡**: æ¯ä¸ª Store éƒ½æ˜¯ä¸€ä¸ªç‹¬ç«‹çš„æ¨¡å—ï¼Œæ— éœ€åµŒå¥—ã€‚
- **å¼ºå¤§çš„å¼€å‘è€…å·¥å…·**: ä¸ Vue Devtools é›†æˆï¼Œè°ƒè¯•ä½“éªŒæä½³ã€‚

## ğŸš€ å¿«é€Ÿä¸Šæ‰‹ Pinia

### æ­¥éª¤ 1: å®‰è£… Pinia
åœ¨ä½ çš„ Vue é¡¹ç›®ä¸­ï¼Œè¿è¡Œä»¥ä¸‹å‘½ä»¤ï¼š
```bash
npm install pinia
# æˆ–è€…
yarn add pinia
```

### æ­¥éª¤ 2: åˆ›å»ºå¹¶æ³¨å†Œ Pinia å®ä¾‹
åœ¨ä½ çš„é¡¹ç›®å…¥å£æ–‡ä»¶ (`main.js` æˆ– `main.ts`) ä¸­ï¼Œä½ éœ€è¦åˆ›å»º Pinia å®ä¾‹å¹¶å°†å…¶ä½œä¸ºæ’ä»¶æä¾›ç»™ Vue åº”ç”¨ã€‚

```js
// main.js
import { createApp } from 'vue'
import { createPinia } from 'pinia' // å¯¼å…¥
import App from './App.vue'

const app = createApp(App)

app.use(createPinia()) // ä½¿ç”¨ Pinia
app.mount('#app')
```

## ğŸ—ï¸ å®šä¹‰ä¸€ä¸ª Store

åœ¨ Pinia ä¸­ï¼Œä¸€ä¸ª Store æ˜¯é€šè¿‡ `defineStore()` å®šä¹‰çš„ã€‚å®ƒæ˜¯ä¸€ä¸ªå‡½æ•°ï¼Œç¬¬ä¸€ä¸ªå‚æ•°æ˜¯ Store çš„**å”¯ä¸€ ID**ã€‚

ä¹ æƒ¯ä¸Šï¼Œæˆ‘ä»¬ä¼šå°†æ¯ä¸ª Store å®šä¹‰åœ¨ `src/stores/` ç›®å½•ä¸‹ã€‚

```js
// src/stores/counter.js
import { defineStore } from 'pinia'
import { ref, computed } from 'vue'

// ä½¿ç”¨ `defineStore` å®šä¹‰ store
// ç¬¬ä¸€ä¸ªå‚æ•°æ˜¯ store çš„å”¯ä¸€ ID: 'counter'
// ç¬¬äºŒä¸ªå‚æ•°æ˜¯ä¸€ä¸ª setup å‡½æ•° (ç±»ä¼¼äºç»„ä»¶çš„ <script setup>)
export const useCounterStore = defineStore('counter', () => {
  // 1. State: å“åº”å¼çŠ¶æ€
  const count = ref(0)
  const name = ref('Eduardo')

  // 2. Getters: è®¡ç®—å±æ€§
  const doubleCount = computed(() => count.value * 2)

  // 3. Actions: æ–¹æ³•
  function increment() {
    count.value++
  }

  // å¿…é¡»è¿”å›æ‰€æœ‰éœ€è¦æš´éœ²ç»™å¤–éƒ¨çš„ state, getters å’Œ actions
  return { count, name, doubleCount, increment }
})
```
è¿™ä¸ª `setup` å‡½æ•°çš„ç»“æ„å’Œ `<script setup>` éå¸¸ç›¸ä¼¼ï¼Œä½ å¯ä»¥ç›´æ¥ä½¿ç”¨ `ref`, `reactive`, `computed` ç­‰ç»„åˆå¼ APIã€‚

### Pinia çš„æ ¸å¿ƒæ¦‚å¿µ

#### 1. State (çŠ¶æ€)
`state` æ˜¯ Store çš„æ ¸å¿ƒï¼Œå®ƒæ˜¯ä¸€äº›å“åº”å¼æ•°æ®ã€‚åœ¨ `setup` store ä¸­ï¼Œå®ƒå°±æ˜¯ä½ å®šä¹‰çš„ `ref` æˆ– `reactive` å˜é‡ã€‚
```js
const count = ref(0)
```

#### 2. Getters (è®¡ç®—å±æ€§)
`getters` ç­‰åŒäº Store çš„è®¡ç®—å±æ€§ã€‚å®ƒä»¬æ˜¯åŸºäº `state` æ´¾ç”Ÿå‡ºæ¥çš„å€¼ï¼Œå¹¶ä¸”ä¼šè¢«ç¼“å­˜ã€‚åœ¨ `setup` store ä¸­ï¼Œå®ƒä»¬å°±æ˜¯ `computed` å±æ€§ã€‚
```js
const doubleCount = computed(() => count.value * 2)
```

#### 3. Actions (åŠ¨ä½œ)
`actions` ç›¸å½“äºç»„ä»¶ä¸­çš„ `methods`ã€‚å®ƒä»¬ç”¨äºä¿®æ”¹ `state`ï¼Œå¹¶ä¸”å¯ä»¥æ˜¯**å¼‚æ­¥**çš„ã€‚åœ¨ `setup` store ä¸­ï¼Œå®ƒä»¬å°±æ˜¯æ™®é€šçš„ `function`ã€‚
```js
function increment() {
  count.value++
}

// å¼‚æ­¥ action
async function fetchData() {
  const response = await fetch('/api/data')
  const data = await response.json()
  // ä¿®æ”¹ state
}
```

## âš™ï¸ åœ¨ç»„ä»¶ä¸­ä½¿ç”¨ Store

åœ¨ä»»ä½•ç»„ä»¶çš„ `<script setup>` ä¸­ï¼Œä½ åªéœ€è¦å¯¼å…¥å¹¶è°ƒç”¨ç›¸åº”çš„ `use...Store` å‡½æ•°ï¼Œå°±å¯ä»¥è®¿é—® Storeã€‚

```vue
<script setup>
import { useCounterStore } from '@/stores/counter'

// è·å– counter store çš„å®ä¾‹
const counterStore = useCounterStore()

// ç°åœ¨ä½ å¯ä»¥ç›´æ¥è®¿é—® state, getters å’Œ actions
// counterStore.count
// counterStore.doubleCount
// counterStore.increment()
</script>

<template>
  <div>
    <!-- ç›´æ¥ä» store å®ä¾‹ä¸­è¯»å– state å’Œ getters -->
    <p>Current count: {{ counterStore.count }}</p>
    <p>Double count: {{ counterStore.doubleCount }}</p>

    <!-- è°ƒç”¨ actions -->
    <button @click="counterStore.increment">Increment</button>
  </div>
</template>
```

### è§£æ„ Store
å¦‚æœä½ æƒ³ä» Store ä¸­è§£æ„å±æ€§ï¼ŒåŒæ—¶åˆä¿æŒå…¶å“åº”æ€§ï¼Œä½ éœ€è¦ä½¿ç”¨ `storeToRefs`ã€‚
```vue
<script setup>
import { storeToRefs } from 'pinia'
import { useCounterStore } from '@/stores/counter'

const counterStore = useCounterStore()

// `storeToRefs` åªä¼šè½¬æ¢ state å’Œ getters
// actions å¯ä»¥ç›´æ¥è§£æ„
const { count, doubleCount } = storeToRefs(counterStore)
const { increment } = counterStore
</script>

<template>
  <!-- ç°åœ¨ä½ å¯ä»¥ç›´æ¥ä½¿ç”¨è§£æ„åçš„å˜é‡ -->
  <p>Current count: {{ count }}</p>
  <p>Double count: {{ doubleCount }}</p>
  <button @click="increment">Increment</button>
</template>
```

## ğŸ§© æ’ä»¶ï¼šæ•°æ®æŒä¹…åŒ–

åœ¨å®é™…é¡¹ç›®ä¸­ï¼Œæˆ‘ä»¬ç»å¸¸éœ€è¦å°† Store ä¸­çš„æ•°æ®ï¼ˆå¦‚ç™»å½•çŠ¶æ€ã€ç”¨æˆ·åå¥½ï¼‰æŒä¹…åŒ–åˆ°æµè§ˆå™¨çš„ `localStorage` ä¸­ï¼Œè¿™æ ·å³ä½¿ç”¨æˆ·åˆ·æ–°é¡µé¢ï¼Œæ•°æ®ä¹Ÿä¸ä¼šä¸¢å¤±ã€‚

æˆ‘ä»¬å¯ä»¥é€šè¿‡ Pinia æ’ä»¶è½»æ¾å®ç°è¿™ä¸€ç‚¹ã€‚ä¸€ä¸ªå¸¸ç”¨çš„æ’ä»¶æ˜¯ `pinia-plugin-persistedstate`ã€‚

### æ­¥éª¤ 1: å®‰è£…æ’ä»¶
```bash
npm install pinia-plugin-persistedstate
```

### æ­¥éª¤ 2: æ³¨å†Œæ’ä»¶
```js
// main.js
import { createApp } from 'vue'
import { createPinia } from 'pinia'
import piniaPluginPersistedstate from 'pinia-plugin-persistedstate' // å¯¼å…¥
import App from './App.vue'

const pinia = createPinia()
pinia.use(piniaPluginPersistedstate) // ä½¿ç”¨æ’ä»¶

const app = createApp(App)
app.use(pinia) // å°†é…ç½®å¥½çš„ pinia å®ä¾‹ä¼ ç»™ app
app.mount('#app')
```

### æ­¥éª¤ 3: åœ¨ Store ä¸­å¯ç”¨æŒä¹…åŒ–
åœ¨ `defineStore` çš„ç¬¬ä¸‰ä¸ªå‚æ•°ä¸­ï¼Œè®¾ç½® `persist: true`ã€‚
```js
// src/stores/user.js
import { defineStore } from 'pinia'

export const useUserStore = defineStore('user', () => {
  const user = ref(null)
  const token = ref('')
  
  return { user, token }
}, {
  persist: true, // å¯ç”¨æŒä¹…åŒ–
})
```
ç°åœ¨ï¼Œ`user` store ä¸­çš„æ‰€æœ‰æ•°æ®éƒ½ä¼šè‡ªåŠ¨ä¿å­˜åˆ° `localStorage` ä¸­äº†ï¼

## ğŸ“š å­¦ä¹ èµ„æº

- **[Pinia å®˜æ–¹æ–‡æ¡£](https://pinia.vuejs.org/)**: å­¦ä¹  Pinia çš„æœ€ä½³èµ·ç‚¹ã€‚
- **[Pinia æŒä¹…åŒ–æ’ä»¶](https://prazdevs.github.io/pinia-plugin-persistedstate/)**: äº†è§£å¦‚ä½•æŒä¹…åŒ–ä½ çš„ Store æ•°æ®ã€‚

## ğŸ” çŸ¥è¯†æ£€æŸ¥

- [ ] ç†è§£ä¸ºä»€ä¹ˆéœ€è¦çŠ¶æ€ç®¡ç†åº“ï¼Œä»¥åŠ Pinia çš„ä¼˜åŠ¿ã€‚
- [ ] æŒæ¡å¦‚ä½•å®‰è£…å’Œæ³¨å†Œ Piniaã€‚
- [ ] èƒ½å¤Ÿä½¿ç”¨ `defineStore` å®šä¹‰ä¸€ä¸ªåŒ…å« state, getters å’Œ actions çš„ Storeã€‚
- [ ] å­¦ä¼šåœ¨ç»„ä»¶ä¸­è°ƒç”¨ Store å¹¶è®¿é—®å…¶æ•°æ®å’Œæ–¹æ³•ã€‚
- [ ] çŸ¥é“å¦‚ä½•ä½¿ç”¨ `storeToRefs` æ¥è§£æ„ Store å¹¶ä¿æŒå“åº”æ€§ã€‚
- [ ] äº†è§£å¦‚ä½•ä½¿ç”¨ Pinia æ’ä»¶æ¥å®ç°æ•°æ®æŒä¹…åŒ–ã€‚

---

**ä¸Šä¸€èŠ‚**ï¼š[3.2 ç»„ä»¶åŒ–å¼€å‘](3.2-components.md) | **ä¸‹ä¸€èŠ‚**ï¼š[3.4 è·¯ç”±å’Œå¯¼èˆª](3.4-routing.md) 