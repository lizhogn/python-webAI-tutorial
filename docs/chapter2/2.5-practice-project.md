# 2.5 å®è·µé¡¹ç›®ï¼šç”¨æˆ·ä¸æƒé™ç®¡ç†ç³»ç»Ÿ

## ğŸ“– é¡¹ç›®ç›®æ ‡

é€šè¿‡æœ¬é¡¹ç›®ï¼Œç»¼åˆè¿ç”¨æœ¬ç« æ‰€å­¦çš„ FastAPIã€æ•°æ®åº“ã€API è®¾è®¡ã€è®¤è¯ä¸å®‰å…¨ç­‰çŸ¥è¯†ï¼Œå®Œæˆä¸€ä¸ªåŸºç¡€çš„"ç”¨æˆ·ä¸æƒé™ç®¡ç†ç³»ç»Ÿ"ã€‚

## ğŸ—ï¸ é¡¹ç›®éœ€æ±‚

- ç”¨æˆ·æ³¨å†Œã€ç™»å½•ï¼ˆJWT è®¤è¯ï¼‰
- ç”¨æˆ·ä¿¡æ¯ç®¡ç†ï¼ˆå¢åˆ æ”¹æŸ¥ï¼‰
- è§’è‰²ä¸æƒé™åˆ†é…ï¼ˆRBACï¼‰
- ç®¡ç†å‘˜ä¸æ™®é€šç”¨æˆ·æƒé™åŒºåˆ†
- å®‰å…¨é˜²æŠ¤ï¼ˆå¯†ç åŠ å¯†ã€æ¥å£ä¿æŠ¤ã€é”™è¯¯å¤„ç†ï¼‰

## ğŸ“¦ æŠ€æœ¯æ ˆ
- FastAPI
- SQLAlchemy
- SQLite/PostgreSQL
- Pydantic
- JWTï¼ˆjoseï¼‰
- passlibï¼ˆå¯†ç åŠ å¯†ï¼‰

## ğŸ—‚ï¸ é¡¹ç›®ç»“æ„
```
user-auth-demo/
â”œâ”€â”€ main.py
â”œâ”€â”€ models.py
â”œâ”€â”€ database.py
â”œâ”€â”€ schemas.py
â”œâ”€â”€ crud.py
â”œâ”€â”€ security.py
â”œâ”€â”€ requirements.txt
â””â”€â”€ README.md
```

## ğŸš€ ä¸»è¦åŠŸèƒ½ä»£ç ç¤ºä¾‹

### 1. ç”¨æˆ·æ³¨å†Œä¸å¯†ç åŠ å¯†
```python
# schemas.py
from pydantic import BaseModel, EmailStr
class UserCreate(BaseModel):
    username: str
    email: EmailStr
    password: str

# security.py
from passlib.context import CryptContext
pwd_context = CryptContext(schemes=["bcrypt"], deprecated="auto")
def hash_password(password: str):
    return pwd_context.hash(password)

def verify_password(plain, hashed):
    return pwd_context.verify(plain, hashed)

# crud.py
def create_user(db: Session, user: UserCreate):
    db_user = User(
        username=user.username,
        email=user.email,
        hashed_password=hash_password(user.password)
    )
    db.add(db_user)
    db.commit()
    db.refresh(db_user)
    return db_user
```

### 2. JWT ç™»å½•è®¤è¯
```python
# security.py
from jose import jwt
from datetime import datetime, timedelta
SECRET_KEY = "your-secret-key"
ALGORITHM = "HS256"
ACCESS_TOKEN_EXPIRE_MINUTES = 30

def create_access_token(data: dict, expires_delta: timedelta = None):
    to_encode = data.copy()
    expire = datetime.utcnow() + (expires_delta or timedelta(minutes=15))
    to_encode.update({"exp": expire})
    return jwt.encode(to_encode, SECRET_KEY, algorithm=ALGORITHM)

# main.py
from fastapi.security import OAuth2PasswordBearer, OAuth2PasswordRequestForm
oauth2_scheme = OAuth2PasswordBearer(tokenUrl="/token")

@app.post("/token")
async def login(form_data: OAuth2PasswordRequestForm = Depends()):
    user = authenticate_user(form_data.username, form_data.password)
    if not user:
        raise HTTPException(status_code=400, detail="ç”¨æˆ·åæˆ–å¯†ç é”™è¯¯")
    access_token = create_access_token(data={"sub": user.username})
    return {"access_token": access_token, "token_type": "bearer"}
```

### 3. è§’è‰²ä¸æƒé™æ§åˆ¶
```python
# models.py
from sqlalchemy import Enum
import enum
class RoleEnum(str, enum.Enum):
    user = "user"
    admin = "admin"

class User(Base):
    # ...
    role = Column(Enum(RoleEnum), default=RoleEnum.user)

# main.py
def get_current_user(token: str = Depends(oauth2_scheme)):
    # è§£ç  tokenï¼Œè·å–ç”¨æˆ·ä¿¡æ¯
    ...

def require_admin(current_user = Depends(get_current_user)):
    if current_user.role != "admin":
        raise HTTPException(status_code=403, detail="ä»…ç®¡ç†å‘˜å¯æ“ä½œ")

@app.get("/admin/users", dependencies=[Depends(require_admin)])
async def admin_list_users():
    return get_all_users()
```

### 4. å®‰å…¨é˜²æŠ¤ä¸æœ€ä½³å®è·µ
- å¯†ç åŠ å¯†å­˜å‚¨
- æ‰€æœ‰æ•æ„Ÿæ¥å£éœ€è®¤è¯
- ç»Ÿä¸€é”™è¯¯å¤„ç†
- æ—¥å¿—è®°å½•ä¸ç›‘æ§
- é˜²æ­¢ SQL æ³¨å…¥ï¼ˆä½¿ç”¨ ORMï¼‰

## ğŸ§ª æµ‹è¯•å»ºè®®
- æ³¨å†Œã€ç™»å½•ã€è·å–ç”¨æˆ·ä¿¡æ¯
- æ™®é€šç”¨æˆ·ä¸ç®¡ç†å‘˜æƒé™åŒºåˆ†
- éæ³• tokenã€è¿‡æœŸ token æµ‹è¯•
- SQL æ³¨å…¥ã€æš´åŠ›ç ´è§£ç­‰å®‰å…¨æµ‹è¯•

## ğŸ“š å­¦ä¹ èµ„æº
- [FastAPI å®˜æ–¹æ–‡æ¡£](https://fastapi.tiangolo.com/)
- [SQLAlchemy å®˜æ–¹æ–‡æ¡£](https://docs.sqlalchemy.org/)
- [JWT å®˜æ–¹æ–‡æ¡£](https://jwt.io/introduction)
- [OWASP Top 10](https://owasp.org/www-project-top-ten/)

## ğŸ” çŸ¥è¯†æ£€æŸ¥
- [ ] èƒ½å¤Ÿå®ç°ç”¨æˆ·æ³¨å†Œã€ç™»å½•ã€è®¤è¯
- [ ] èƒ½å¤Ÿå®ç°åŸºäºè§’è‰²çš„æƒé™æ§åˆ¶
- [ ] èƒ½å¤Ÿå®ç°å¯†ç åŠ å¯†ä¸å®‰å…¨é˜²æŠ¤
- [ ] èƒ½å¤Ÿç¼–å†™å®‰å…¨ã€è§„èŒƒçš„ API

---

**ä¸Šä¸€èŠ‚**ï¼š[2.4 è®¤è¯ä¸å®‰å…¨](2.4-authentication.md) | **ä¸‹ä¸€ç« **ï¼š[ç¬¬ä¸‰ç«  å‰ç«¯å¼€å‘](../chapter3/README.md) 