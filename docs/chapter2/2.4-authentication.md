# 2.4 è®¤è¯ä¸å®‰å…¨

## ğŸ“– æ¦‚è¿°

æœ¬ç« å°†ç³»ç»Ÿè®²è§£ Web åº”ç”¨ä¸­çš„è®¤è¯ä¸å®‰å…¨ï¼ŒåŒ…æ‹¬å¸¸è§è®¤è¯æ–¹å¼ï¼ˆå¦‚ JWTã€OAuth2ï¼‰ã€å¯†ç åŠ å¯†ã€æƒé™æ§åˆ¶ã€å®‰å…¨æœ€ä½³å®è·µç­‰ï¼Œå¸®åŠ©ä½ æ„å»ºå®‰å…¨å¯é çš„åç«¯æœåŠ¡ã€‚

## ğŸ”‘ è®¤è¯åŸºç¡€

### è®¤è¯ä¸æˆæƒåŒºåˆ«
- **è®¤è¯ï¼ˆAuthenticationï¼‰**ï¼šç¡®è®¤ç”¨æˆ·èº«ä»½ï¼ˆä½ æ˜¯è°ï¼‰
- **æˆæƒï¼ˆAuthorizationï¼‰**ï¼šç¡®è®¤ç”¨æˆ·æƒé™ï¼ˆä½ èƒ½åšä»€ä¹ˆï¼‰

### å¸¸è§è®¤è¯æ–¹å¼
- **Session/Cookie**ï¼šä¼ ç»Ÿ Web ç™»å½•ï¼ŒæœåŠ¡ç«¯ä¿å­˜ä¼šè¯
- **Tokenï¼ˆJWTï¼‰**ï¼šå‰åç«¯åˆ†ç¦»å¸¸ç”¨ï¼ŒæœåŠ¡ç«¯æ— çŠ¶æ€
- **OAuth2**ï¼šç¬¬ä¸‰æ–¹ç™»å½•ã€æˆæƒ
- **API Key**ï¼šæ¥å£çº§åˆ«è®¤è¯

## ğŸ”’ å¯†ç å®‰å…¨

### å¯†ç å­˜å‚¨åŸåˆ™
- ç»ä¸æ˜æ–‡å­˜å‚¨å¯†ç 
- ä½¿ç”¨å¼ºå“ˆå¸Œç®—æ³•ï¼ˆå¦‚ bcryptã€argon2ï¼‰
- åŠ ç›ï¼ˆsaltï¼‰é˜²æ­¢å½©è™¹è¡¨æ”»å‡»

### å¯†ç å“ˆå¸Œç¤ºä¾‹
```python
from passlib.context import CryptContext

pwd_context = CryptContext(schemes=["bcrypt"], deprecated="auto")

def hash_password(password: str) -> str:
    return pwd_context.hash(password)

def verify_password(plain_password: str, hashed_password: str) -> bool:
    return pwd_context.verify(plain_password, hashed_password)
```

## ğŸ›¡ï¸ JWT è®¤è¯

### JWT åŸºç¡€
- **JWTï¼ˆJSON Web Tokenï¼‰**ï¼šä¸€ç§æ— çŠ¶æ€ã€è·¨å¹³å°çš„ä»¤ç‰Œè®¤è¯æœºåˆ¶
- ç»“æ„ï¼š`header.payload.signature`
- å…¸å‹æµç¨‹ï¼šç™»å½•æˆåŠŸåç­¾å‘ tokenï¼Œå‰ç«¯å­˜å‚¨å¹¶åœ¨åç»­è¯·æ±‚ä¸­æºå¸¦

### FastAPI JWT ç¤ºä¾‹
```python
from fastapi import FastAPI, Depends, HTTPException, status
from fastapi.security import OAuth2PasswordBearer, OAuth2PasswordRequestForm
from jose import JWTError, jwt
from datetime import datetime, timedelta
from typing import Optional

SECRET_KEY = "your-secret-key"
ALGORITHM = "HS256"
ACCESS_TOKEN_EXPIRE_MINUTES = 30

oauth2_scheme = OAuth2PasswordBearer(tokenUrl="/token")

app = FastAPI()

def create_access_token(data: dict, expires_delta: Optional[timedelta] = None):
    to_encode = data.copy()
    expire = datetime.utcnow() + (expires_delta or timedelta(minutes=15))
    to_encode.update({"exp": expire})
    return jwt.encode(to_encode, SECRET_KEY, algorithm=ALGORITHM)

@app.post("/token")
async def login(form_data: OAuth2PasswordRequestForm = Depends()):
    user = authenticate_user(form_data.username, form_data.password)
    if not user:
        raise HTTPException(status_code=400, detail="Incorrect username or password")
    access_token = create_access_token(data={"sub": user.username})
    return {"access_token": access_token, "token_type": "bearer"}

@app.get("/users/me")
async def read_users_me(token: str = Depends(oauth2_scheme)):
    try:
        payload = jwt.decode(token, SECRET_KEY, algorithms=[ALGORITHM])
        username: str = payload.get("sub")
        if username is None:
            raise HTTPException(status_code=401, detail="Invalid token")
        return {"username": username}
    except JWTError:
        raise HTTPException(status_code=401, detail="Invalid token")
```

## ğŸŒ OAuth2 æˆæƒ

### OAuth2 æµç¨‹ç®€ä»‹
- ç”¨æˆ·ç‚¹å‡»ç¬¬ä¸‰æ–¹ç™»å½•
- è·³è½¬åˆ°æˆæƒæœåŠ¡å™¨è®¤è¯
- æˆæƒæœåŠ¡å™¨å›è°ƒå¹¶è¿”å› code
- åç«¯ç”¨ code æ¢å– access_token
- ç”¨ access_token è·å–ç”¨æˆ·ä¿¡æ¯

### FastAPI OAuth2 ç¤ºä¾‹
```python
from fastapi.security import OAuth2PasswordBearer

oauth2_scheme = OAuth2PasswordBearer(tokenUrl="/token")

@app.get("/protected")
async def protected_route(token: str = Depends(oauth2_scheme)):
    # éªŒè¯ token å¹¶è¿”å›ç”¨æˆ·ä¿¡æ¯
    ...
```

## ğŸ›¡ï¸ æƒé™æ§åˆ¶

### RBACï¼ˆåŸºäºè§’è‰²çš„è®¿é—®æ§åˆ¶ï¼‰
- ç”¨æˆ·åˆ†é…è§’è‰²ï¼Œè§’è‰²æ‹¥æœ‰æƒé™
- ä»£ç å®ç°æ—¶å¯ç”¨è£…é¥°å™¨æˆ–ä¾èµ–æ³¨å…¥

```python
from fastapi import Depends, HTTPException
from enum import Enum

class Role(str, Enum):
    USER = "user"
    ADMIN = "admin"

def get_current_user_role():
    # å‡è®¾ä» token è§£ç è·å¾—
    return "user"

def require_role(role: Role):
    def dependency(current_role: str = Depends(get_current_user_role)):
        if current_role != role:
            raise HTTPException(status_code=403, detail="æƒé™ä¸è¶³")
    return dependency

@app.get("/admin", dependencies=[Depends(require_role(Role.ADMIN))])
async def admin_only():
    return {"msg": "åªæœ‰ç®¡ç†å‘˜å¯è§"}
```

## ğŸ›¡ï¸ å¸¸è§å®‰å…¨é£é™©ä¸é˜²æŠ¤

- **SQL æ³¨å…¥**ï¼šä½¿ç”¨ ORMã€å‚æ•°åŒ–æŸ¥è¯¢
- **XSS**ï¼šå‰ç«¯è¾“å‡ºæ—¶è½¬ä¹‰
- **CSRF**ï¼šä½¿ç”¨ token éªŒè¯ã€SameSite Cookie
- **æš´åŠ›ç ´è§£**ï¼šç™»å½•é™æµã€éªŒè¯ç 
- **ä¿¡æ¯æ³„éœ²**ï¼šé”™è¯¯ä¿¡æ¯ä¸æš´éœ²æ•æ„Ÿæ•°æ®
- **æ•æ„Ÿä¿¡æ¯åŠ å¯†**ï¼šå¦‚æ‰‹æœºå·ã€é‚®ç®±ç­‰

## ğŸ” HTTPS ä¸åŠ å¯†
- å¼ºåˆ¶ä½¿ç”¨ HTTPS
- è¯ä¹¦ç”³è¯·ä¸è‡ªåŠ¨ç»­æœŸï¼ˆLet's Encryptï¼‰
- ä¼ è¾“å±‚åŠ å¯†ï¼Œé˜²æ­¢ä¸­é—´äººæ”»å‡»

## ğŸ“š å­¦ä¹ èµ„æº
- [FastAPI å®‰å…¨æ–‡æ¡£](https://fastapi.tiangolo.com/tutorial/security/)
- [OWASP Top 10](https://owasp.org/www-project-top-ten/)
- [JWT å®˜æ–¹æ–‡æ¡£](https://jwt.io/introduction)
- [OAuth2 è§„èŒƒ](https://oauth.net/2/)

## ğŸ” çŸ¥è¯†æ£€æŸ¥
- [ ] ç†è§£è®¤è¯ä¸æˆæƒçš„åŒºåˆ«
- [ ] æŒæ¡ JWTã€OAuth2 çš„åŸºæœ¬ç”¨æ³•
- [ ] èƒ½å¤Ÿå®ç°å¯†ç åŠ å¯†ä¸æ ¡éªŒ
- [ ] èƒ½å¤Ÿå®ç°åŸºäºè§’è‰²çš„æƒé™æ§åˆ¶
- [ ] äº†è§£å¸¸è§ Web å®‰å…¨é£é™©åŠé˜²æŠ¤æªæ–½

---

**ä¸Šä¸€èŠ‚**ï¼š[2.3 API è®¾è®¡](2.3-api-design.md) | **ä¸‹ä¸€èŠ‚**ï¼š[2.5 å®è·µé¡¹ç›®](2.5-practice-project.md) 