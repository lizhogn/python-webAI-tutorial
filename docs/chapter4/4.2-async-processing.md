# 4.2 å¼‚æ­¥å¤„ç†

## ğŸ“– æ¦‚è¿°

æœ¬ç« ä»‹ç» AI æœåŠ¡ä¸­çš„å¼‚æ­¥ä»»åŠ¡å¤„ç†ï¼ŒåŒ…æ‹¬å¼‚æ­¥ APIã€ä»»åŠ¡é˜Ÿåˆ—ï¼ˆå¦‚ Celeryã€RQï¼‰ã€WebSocket å®æ—¶æ¨é€ç­‰ï¼Œæå‡æ¨¡å‹æœåŠ¡çš„å¹¶å‘èƒ½åŠ›å’Œç”¨æˆ·ä½“éªŒã€‚

## âš¡ ä¸ºä»€ä¹ˆéœ€è¦å¼‚æ­¥ï¼Ÿ
- æ¨ç†è€—æ—¶é•¿ï¼Œä¸èƒ½é˜»å¡ä¸»çº¿ç¨‹
- æ”¯æŒå¤§æ‰¹é‡/é«˜å¹¶å‘è¯·æ±‚
- ä»»åŠ¡ç»“æœå¯å›è°ƒ/æ¨é€

## ğŸ—ï¸ å¸¸è§å¼‚æ­¥æ–¹æ¡ˆ
- **FastAPI åŸç”Ÿ async/await**ï¼šé€‚åˆ IO å¯†é›†å‹ã€çŸ­æ—¶ä»»åŠ¡
- **Celery + Redis/RabbitMQ**ï¼šåˆ†å¸ƒå¼ä»»åŠ¡é˜Ÿåˆ—ï¼Œé€‚åˆå¤§è§„æ¨¡å¼‚æ­¥ä»»åŠ¡
- **RQï¼ˆRedis Queueï¼‰**ï¼šè½»é‡çº§ä»»åŠ¡é˜Ÿåˆ—
- **WebSocket**ï¼šå®æ—¶æ¨é€è¿›åº¦/ç»“æœ

## ğŸš€ FastAPI å¼‚æ­¥æ¥å£
```python
from fastapi import FastAPI
import asyncio

app = FastAPI()

@app.get('/async-demo')
async def async_demo():
    await asyncio.sleep(2)
    return {'msg': 'å¼‚æ­¥å“åº”'}
```

## ğŸ­ Celery ä»»åŠ¡é˜Ÿåˆ—

### 1. å®‰è£…
```bash
pip install celery redis
```

### 2. å®šä¹‰ä»»åŠ¡
```python
# tasks.py
from celery import Celery
celery_app = Celery('tasks', broker='redis://localhost:6379/0')

@celery_app.task
def long_task(x, y):
    import time; time.sleep(5)
    return x + y
```

### 3. FastAPI è°ƒç”¨å¼‚æ­¥ä»»åŠ¡
```python
from fastapi import FastAPI
from tasks import long_task

app = FastAPI()

@app.post('/add')
def add(x: int, y: int):
    task = long_task.delay(x, y)
    return {'task_id': task.id}
```

### 4. æŸ¥è¯¢ä»»åŠ¡ç»“æœ
```python
@app.get('/result/{task_id}')
def get_result(task_id: str):
    from tasks import celery_app
    result = celery_app.AsyncResult(task_id)
    if result.ready():
        return {'result': result.get()}
    return {'status': 'pending'}
```

## ğŸŒ WebSocket å®æ—¶æ¨é€
```python
from fastapi import FastAPI, WebSocket
app = FastAPI()

@app.websocket('/ws/progress')
async def ws_progress(ws: WebSocket):
    await ws.accept()
    for i in range(1, 11):
        await ws.send_json({'progress': i * 10})
        await asyncio.sleep(0.5)
    await ws.close()
```

## ğŸ› ï¸ å¼‚æ­¥å¤„ç†æœ€ä½³å®è·µ
- ä»»åŠ¡å¹‚ç­‰ã€å¯é‡è¯•
- ä»»åŠ¡è¶…æ—¶ä¸å¤±è´¥å¤„ç†
- æ—¥å¿—ä¸ç›‘æ§
- å‰ç«¯è½®è¯¢/æ¨é€ç»“åˆ

## ğŸ“š å­¦ä¹ èµ„æº
- [FastAPI å¼‚æ­¥æ–‡æ¡£](https://fastapi.tiangolo.com/async/)
- [Celery å®˜æ–¹æ–‡æ¡£](https://docs.celeryq.dev/zh/latest/)
- [RQ å®˜æ–¹æ–‡æ¡£](https://python-rq.org/)
- [WebSocket æ•™ç¨‹](https://developer.mozilla.org/zh-CN/docs/Web/API/WebSockets_API)

## ğŸ” çŸ¥è¯†æ£€æŸ¥
- [ ] ç†è§£å¼‚æ­¥å¤„ç†çš„åœºæ™¯å’Œæ„ä¹‰
- [ ] èƒ½å¤Ÿç”¨ FastAPI/Celery å®ç°å¼‚æ­¥ä»»åŠ¡
- [ ] èƒ½å¤Ÿç”¨ WebSocket å®ç°å®æ—¶æ¨é€
- [ ] èƒ½å¤Ÿå¤„ç†å¼‚æ­¥ä»»åŠ¡çš„çŠ¶æ€å’Œç»“æœ

---

**ä¸Šä¸€èŠ‚**ï¼š[4.1 æ¨¡å‹æœåŠ¡åŒ–](4.1-model-serving.md) | **ä¸‹ä¸€èŠ‚**ï¼š[4.3 æ€§èƒ½ä¼˜åŒ–](4.3-performance.md) 